<div class="discounts-page" *ngIf="vm$ | async as vm">

  <div class="discount-switcher">
    <button
      *ngFor="let t of discountTypes"
      (click)="selectDiscountType(t)"
      [class.active]="t === vm.selectedType">
      {{ typeLabels[t] }}
    </button>
  </div>

  <div *ngIf="vm.loading" class="state">Se încarcă…</div>
  <div *ngIf="vm.error" class="state error">{{ vm.error }}</div>

  <div class="meta" *ngIf="!vm.loading && !vm.error">
    {{ vm.total }} discounturi găsite
  </div>

  <div class="discounts-grid" *ngIf="!vm.loading && !vm.error">
    <div class="discount-card" *ngFor="let d of vm.discounts; trackBy: trackByDiscount">
      <div class="discount-thumb">
        <img *ngIf="d.productImageUrl; else placeholder"
          [src]="d.productImageUrl"
          [alt]="d.productName" 
        />
        <ng-template #placeholder>
          <div class="thumb-placeholder">{{ (d.productName || '?')[0] | uppercase }}</div>
        </ng-template>
      </div>

      <div class="discount-body">
        <div class="discount-top">
          <div>
            <div class="discount-name">{{ d.productName | titlecase }}</div>
            <div class="discount-brand">{{ d.productBrand | titlecase}} • {{ d.quantity }}{{ d.unit }}</div>
          </div>

          <span class="store-pill" [ngClass]="'store-' + d.supermarketName.toLowerCase()">
            {{ d.supermarketName }}
          </span>
        </div>

        <div class="price-row">
          <span class="old-price">
            {{ d.originalPrice | number:'1.2-2' }} RON
          </span>

          <span class="new-price">
            {{ d.discountedPrice | number:'1.2-2' }} RON
          </span>
          
          <span class="percent-pill">
            -{{ d.percentageOfDiscount }}%
          </span>

          <span class="old-unit-price">
            {{ d.unitPriceOriginal | number:'1.2-2' }} RON / {{ d.unitLabel }}
          </span>

          <span class="new-unit-price">
            {{ d.unitPriceDiscounted | number:'1.2-2' }} RON / {{ d.unitLabel }}
          </span>
        </div>

        <div class="discount-footer">
          <div class="discount-valid">
            Valabilitate: {{ d.fromDate | date:'d MMMM' }} – {{ d.toDate | date:'d MMMM' }}
          </div>

          <div class="ends-label">
            <span>⏱ {{ d.endsLabel }}</span>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
